#!/usr/bin/env python3

##############################################################################
#                                                                            #
# Copyright (C) 2024 MachineWare GmbH                                        #
# All Rights Reserved                                                        #
#                                                                            #
# This is work is licensed under the terms described in the LICENSE file     #
# found in the root directory of this source tree.                           #
#                                                                            #
##############################################################################

import subprocess
import sys
import os
import re
import time

registry = subprocess.Popen(['$<TARGET_FILE:sil-kit-registry>', "-s"])

env = os.environ
for var in [v for v in re.split(r'(?<!\\);', '@env@') if v]:
    val = var.split('=', 1)
    env[val[0].strip()] = val[1].strip() if len(val) > 1 else ''
for var, val in env.items():
    print(f'{var} = {val}')

time.sleep(5)

result = subprocess.run([sys.argv[1], '@CMAKE_CURRENT_SOURCE_DIR@'], env=env)

registry.terminate()
sys.exit(result.returncode)
